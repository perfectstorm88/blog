- [案例:订单系统](#%e6%a1%88%e4%be%8b%e8%ae%a2%e5%8d%95%e7%b3%bb%e7%bb%9f)
  - [业务流程图](#%e4%b8%9a%e5%8a%a1%e6%b5%81%e7%a8%8b%e5%9b%be)
    - [学员录入、订单、付款完整流程](#%e5%ad%a6%e5%91%98%e5%bd%95%e5%85%a5%e8%ae%a2%e5%8d%95%e4%bb%98%e6%ac%be%e5%ae%8c%e6%95%b4%e6%b5%81%e7%a8%8b)
    - [订单付款流程](#%e8%ae%a2%e5%8d%95%e4%bb%98%e6%ac%be%e6%b5%81%e7%a8%8b)
    - [储值卡充值流程](#%e5%82%a8%e5%80%bc%e5%8d%a1%e5%85%85%e5%80%bc%e6%b5%81%e7%a8%8b)
    - [退课流程](#%e9%80%80%e8%af%be%e6%b5%81%e7%a8%8b)
    - [换课流程](#%e6%8d%a2%e8%af%be%e6%b5%81%e7%a8%8b)
    - [退款流程](#%e9%80%80%e6%ac%be%e6%b5%81%e7%a8%8b)
  - [业务规则](#%e4%b8%9a%e5%8a%a1%e8%a7%84%e5%88%99)
    - [如何实现订单状态从“有效”改为“撤销”时自动把”已收金额"转到储值账户，但“撤销”后不能再改回“有效”](#%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e4%bb%8e%e6%9c%89%e6%95%88%e6%94%b9%e4%b8%ba%e6%92%a4%e9%94%80%e6%97%b6%e8%87%aa%e5%8a%a8%e6%8a%8a%e5%b7%b2%e6%94%b6%e9%87%91%e9%a2%9d%22%e8%bd%ac%e5%88%b0%e5%82%a8%e5%80%bc%e8%b4%a6%e6%88%b7%e4%bd%86%e6%92%a4%e9%94%80%e5%90%8e%e4%b8%8d%e8%83%bd%e5%86%8d%e6%94%b9%e5%9b%9e%e6%9c%89%e6%95%88)
    - [其它规则](#%e5%85%b6%e5%ae%83%e8%a7%84%e5%88%99)
  - [校验规则：](#%e6%a0%a1%e9%aa%8c%e8%a7%84%e5%88%99)
  - [权限和角色：](#%e6%9d%83%e9%99%90%e5%92%8c%e8%a7%92%e8%89%b2)
  - [默认值](#%e9%bb%98%e8%ae%a4%e5%80%bc)
  - [字段隐藏](#%e5%ad%97%e6%ae%b5%e9%9a%90%e8%97%8f)
  - [审批流程](#%e5%ae%a1%e6%89%b9%e6%b5%81%e7%a8%8b)
  
# 案例:订单系统
**场景说明**

- 培训部使用，登记会员，会员购买课程、付款、财务审核，会员上课
- 另外还支持储值卡，会员也可以只充值不买课程，等到需要购买课程时再消费
- 会员存在退课退款场景
- 会员存在换课场景，比如A课换成B课，并且课的价格不一样
- 会员存在充值后退款场景
  
**角色设定:**

- 财务:负责收款到账
- 教务:对课程、活动进行管理
- 课程顾问:管理各自的学员、订单、收款记录等
- 销售总监：课程顾问的上级领导


**设计的表关系**

![订单系统实体关系图](./img/订单系统实体关系图.jpg)


**存在换课、退课、退款等各种组合场景，因此设计“储值账户”作为中间资金池，起到桥梁作用**

![储值账户的功能](./img/储值账户的功能.jpg)

## 业务流程图

### 学员录入、订单、付款完整流程
![学员录入、订单、付款完整流程](./img/学员录入、订单、付款完整流程.jpg)

### 订单付款流程
![订单付款流程](./img/订单付款流程.jpg)

### 储值卡充值流程
![储值卡充值记录](./img/储值卡充值记录.jpg)

### 退课流程
![退课流程](./img/退课流程.jpg)

### 换课流程
![换课流程](./img/换课流程.jpg)

### 退款流程
![退款流程](./img/退款流程.jpg)

## 业务规则
### 如何实现订单状态从“有效”改为“撤销”时自动把”已收金额"转到储值账户，但“撤销”后不能再改回“有效”

- 1.订单中增加字段"订单撤销次数",初值为0（这个字段为辅助字段，隐藏不可见）
- 2.配置业务规则两条:
    + 2.1 首次改为撤销时，自动把订单的”已收金额"转到储值账户
```
  UPDATE({学员信息表},{学员信息表.ObjectId} == {学员信息} AND {订单已撤销次数} == 0 AND {订单状态} == '撤销',{学员信息表.储值账户},{学员信息表.储值账户} + {已收金额})
```
    + 2.2 每次修改时，如果撤销为撤销，累加订单撤销次数
```
UPDATE({课程订单信息表},{课程订单信息表.ObjectId} == {ObjectId} AND {订单状态} == '撤销',{课程订单信息表.订单已撤销次数},{课程订单信息表.订单已撤销次数} + 1)
```
- 3.配置提交校验规则(“撤销”后不能再改回“有效”)
   校验规则：{订单状态} == '有效' AND {订单已撤销次数} > 0
   提示内容：已经撤销的订单不允许再改为“有效”

### 其它规则
- 当订单收款记录表生效时,自动更新订单表的"已收金额"和"未收金额"
- 当订单收款记录表生效时,如果收款方式== 会员储值卡,自动更新学员表的“储值余额”
- 当充值记录表生效时,自动更新学员表的"储值金额"
- 当退款记录表生效时,自动更新学员表的"储值金额"

## 校验规则：
- 在提交订单收款记录时,如果收款方式==会员储值卡,收款金额不能大于学员表的“储值余额”
- 当提交退款记录时,退款金额不能大于学员表的“储值余额”

## 权限和角色：
- 在钉钉创建部门，进行人员管理
- 在氚云的组织结构中，点击从钉钉同步组织结构
- 角色设置：
  - 在钉钉的“内部通讯录管理”中点击某个人，可以设置该人的角色；可以把钉钉的角色同步到氚云
  - 也可以在氚云系统中增加氚云自己的角色

## 默认值
可以在计算公式中设置，如：

- 默认当前日期:now() 或者today()
- 默认常量：直接写数值
- 如果是选择控件：设置默认选项
- 创建人、修改时间、流水号等自动生成

## 字段隐藏

场景如下：
- 是否开票选项:当选择开票时，需要填写税号、公司、开票内容等信息
- 当订单从有效改为撤销时，需要填写撤销时间

## 审批流程
- 不同流程节点的可见、可写、必填字段不一样
- 可以设置节点的审批人
- 可以设置节点流转条件
  - 如收款方式==储值账户时，不需要财务审批
- 可以设置节点动作
  - 同意，人数、比例
  - 不同意，人数、比例